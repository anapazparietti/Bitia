<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Panel de composición - demo</title>
<style>
  :root{
    --bg:#f3f3f6;
    --panel:#ececf0;
    --card:#d9d9de;
    --accent:#f9f9fb;
    --highlight:#2b7cff;
    --muted:#9b9ba6;
  }
  body{ margin:0; font-family:Inter,system-ui,Arial; background:var(--bg); color:#222; }
  .container{
    max-width:1200px;
    margin:20px auto;
    border:8px solid #fff;
    box-shadow:0 6px 24px rgba(0,0,0,0.08);
    display:grid;
    grid-template-columns: 460px 1fr 140px;
    gap:18px;
    background:#fff;
    padding:14px;
    align-items:start;
  }

  /* izquierda: grid de items (wireframe-like) */
  .grid-panel{
    background:var(--panel);
    padding:16px;
    border-radius:8px;
    height:560px;
    overflow:hidden;
    position:relative;
  }
  .section-title{
    color:var(--muted);
    font-size:13px;
    margin-bottom:8px;
  }
  .pad-grid{
    display:grid;
    grid-template-columns: repeat(3,1fr);
    grid-auto-rows: 110px;
    gap:12px;
    user-select:none;
    height:calc(100% - 28px);
  }
  .pad{
    border-radius:8px;
    background:linear-gradient(180deg,#e6e6eb,#dcdce3);
    display:flex;
    align-items:center;
    justify-content:center;
    position:relative;
    transition:transform .12s ease, box-shadow .12s ease, background .12s;
    cursor:pointer;
    box-shadow: inset 0 -4px 0 rgba(0,0,0,0.03);
  }
  .pad:active{ transform:scale(.995); }
  .pad .label{ font-size:13px; color:#444; pointer-events:none; }
  /* cursor (item under focus) */
  .pad.cursor{
    outline:4px solid rgba(229, 123, 255, 0.351);
    transform: translateY(-3px);
    box-shadow:0 8px 20px rgba(43,124,255,0.12);
  }
  /* selected per group */
  .pad.selected{
    background:linear-gradient(180deg,#ffffff,#eaf3ff);
    border:2px solid var(--highlight);
  }

  /* derecha: stacking / waveform area simplified */
  .composer-panel{
    background:#fff;
    border-radius:8px;
    min-height:560px;
    padding:16px;
    box-shadow: inset 0 1px 0 rgba(0,0,0,0.02);
  }
  .wave-header{ display:flex; gap:12px; align-items:center; margin-bottom:12px; }
  .wave-header .title{ font-weight:600; color:#333; }
  .stack{
    margin-top:8px;
    min-height:420px;
    border-radius:8px;
    border:1px dashed #e2e2e6;
    padding:12px;
    background:linear-gradient(180deg,#fbfbfd,#f5f7fb);
  }
  .stack-item{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:10px;
    border-radius:6px;
    background:#fff;
    box-shadow:0 2px 6px rgba(0,0,0,0.03);
    margin-bottom:8px;
  }
  .stack-item .meta{ font-size:13px; color:#222; }
  .stack-item .btn{ background:#f2f2f6; padding:6px 8px; border-radius:6px; cursor:pointer; font-size:13px; color:#444; border:none; }
  .controls{ margin-top:10px; color:var(--muted); font-size:13px; }

  /* right column: vertical big buttons (wireframe right) */
  .rightbar{
    background:var(--panel);
    padding:14px;
    border-radius:8px;
    height:560px;
    display:flex;
    flex-direction:column;
    gap:18px;
    align-items:center;
    justify-content:flex-start;
  }
  .wire-btn{ width:64px; height:64px; border-radius:8px; background:#fff; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 10px rgba(0,0,0,0.03); }
  .wire-btn.circle{ border-radius:50%; width:84px; height:84px; }

  /* helper footer on the container bottom */
  .hint{
    grid-column:1/-1;
    text-align:center;
    padding:8px 0;
    color:var(--muted);
    font-size:13px;
  }

  @media (max-width:980px){
    .container{ grid-template-columns:1fr; padding:10px; }
    .rightbar{ order:3; height:auto; flex-direction:row; justify-content:space-around; }
  }
</style>
</head>
<body>

<div class="container" tabindex="0">
  <div class="grid-panel" id="gridPanel">
    <div class="section-title">Instrumentos — usa rueda para moverte entre los 3 items de la fila</div>
    <div class="pad-grid" id="padGrid" aria-label="Grid de instrumentos">
      <!-- 12 pads: 4 filas x 3 columnas -->
    </div>
  </div>

  <div class="composer-panel" aria-live="polite">
    <div class="wave-header">
      <div class="title">Compositor</div>
      <div class="controls">Teclas: <strong>a</strong>/<strong>d</strong> mover fila • <strong>j</strong> seleccionar • rueda: cambiar item</div>
    </div>

    <div class="stack" id="stackArea">
      <div style="color:var(--muted); font-size:13px;">Pistas seleccionadas (apiladas):</div>
      <!-- stacked items aparecerán aquí -->
    </div>

    <div style="margin-top:12px; color:var(--muted); font-size:13px;">
      Nota: demo con tonos generados (WebAudio). Para usar archivos reales, ver comentarios en el JS.
    </div>
  </div>

  <aside class="rightbar">
    <div class="wire-btn" title="preview box">X</div>
    <div class="wire-btn circle" title="play/stop">▶︎</div>
    <div class="wire-btn" title="save">⇪</div>
  </aside>

  <div class="hint">Fila activa marcada con borde azul claro; item con selección tiene borde sólido azul.</div>
</div>

<script>
/*
  Lógica JS:
  - 4 filas: 0:guitarras,1:baterias,2:pianos,3:voces
  - 3 columnas: 0,1,2
  - currentRow, currentCol controlan el "cursor"
  - wheel sobre grid -> mueve currentCol (izq/der)
  - teclas a/d -> fila anterior/siguiente (wrap)
  - j -> seleccionar item actual; una selección por fila
  - selected[row] almacena el objeto seleccionado (col, nodes...) y se reproduce con WebAudio
  - En este demo uso WebAudio y osciladores (tono distinto por item) para simular pistas.
    Para usar archivos reales, reemplaza la función playTone(...) por la carga de un AudioBuffer o HTMLAudioElement.
*/

const padGrid = document.getElementById('padGrid');
const stackArea = document.getElementById('stackArea');
const gridPanel = document.getElementById('gridPanel');

const ROWS = 4, COLS = 3;
let currentRow = 0, currentCol = 0;
const labels = [
  ['Guitarra 1','Guitarra 2','Guitarra 3'],
  ['Bateria 1','Bateria 2','Bateria 3'],
  ['Piano 1','Piano 2','Piano 3'],
  ['Voz 1','Voz 2','Voz 3']
];

// WebAudio setup (activated on first user gesture)
let audioCtx = null;
function ensureAudio(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
}

// store selected per row: {col, node, gain, label}
const selected = [null,null,null,null];
// Imagen de fondo para cada pad
const padImages = [
  ['guitarra1.jpg', 'guitarra2.jpg', 'guitarra3.jpg'],
  ['bateria1.jpg', 'bateria2.jpg', 'bateria3.jpg'],
  ['piano1.jpg', 'piano2.jpg', 'piano3.jpg'],
  ['voz1.jpg', 'voz2.jpg', 'voz3.jpg']
];


function buildGrid(){
  padGrid.innerHTML = '';
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      const el = document.createElement('div');
      el.className = 'pad';

      el.style.backgroundImage = `url('${padImages[r][c]}')`;
        el.style.backgroundSize = 'cover';
        el.style.backgroundPosition = 'center';


      el.dataset.row = r;
      el.dataset.col = c;
      el.tabIndex = 0;
      el.innerHTML = `<div class="label">${labels[r][c]}</div>`;
      el.addEventListener('click', (e)=>{
        // click sets cursor and selects
        currentRow = r; currentCol = c;
        updateCursor();
        selectCurrent();
      });
      el.addEventListener('focus', ()=>{ currentRow=r; currentCol=c; updateCursor(); });
      padGrid.appendChild(el);
    }
  }
  updateCursor();
  refreshSelectionsUI();
}

function getPadElement(row,col){
  const idx = row*COLS + col;
  return padGrid.children[idx];
}

function updateCursor(){
  // remove cursor class
  Array.from(padGrid.children).forEach(el => el.classList.remove('cursor'));
  const el = getPadElement(currentRow,currentCol);
  if(el) el.classList.add('cursor');
  // keep aria or scroll visibility if needed
  // we won't change scroll (fixed), but could highlight row more strongly
}

function clampMod(v,mod){
  return ((v % mod) + mod) % mod;
}

// wheel: move horizontally within the current row
padGrid.addEventListener('wheel', (e)=>{
  e.preventDefault();
  // deltaY positive -> move next column; negative -> prev
  const delta = e.deltaY;
  if(delta > 0){
    currentCol = clampMod(currentCol + 1, COLS);
  } else {
    currentCol = clampMod(currentCol - 1, COLS);
  }
  updateCursor();
});

// keyboard handling
window.addEventListener('keydown', (e)=>{
  // avoid if typing in an input (none here but safety)
  const tag = document.activeElement && document.activeElement.tagName;
  if(tag === 'INPUT' || tag === 'TEXTAREA') return;

  if(e.key === 'd' || e.key === 'D'){
    currentRow = clampMod(currentRow + 1, ROWS);
    // reset col to 0 to emphasize switching row (optional)
    // currentCol = 0;
    updateCursor();
  } else if(e.key === 'a' || e.key === 'A'){
    currentRow = clampMod(currentRow - 1, ROWS);
    updateCursor();
  } else if(e.key === 'j' || e.key === 'J'){
    selectCurrent();
  } else if(e.key === ' '){
    // space control: optional play/pause all
  }
});

function selectCurrent(){
  ensureAudio();
  if(audioCtx.state === 'suspended'){
    audioCtx.resume();
  }
  const row = currentRow, col = currentCol;
  // if there's already a selection in this row, replace it
  if(selected[row] && selected[row].col === col){
    // already selected -> deselect (toggle)
    stopSelection(row);
  } else {
    // stop previous selection in row if exists
    if(selected[row]) stopSelection(row);
    // start new
    const label = labels[row][col];
    const nodeObj = playToneFor(row,col); // returns {source/gain,...}
    selected[row] = {col, label, nodeObj};
  }
  refreshSelectionsUI();
  refreshGridSelectedMarkers();
}

/* --------- WebAudio demo playback ---------
   playToneFor(row,col) crea un oscilador continuamente
   En implementación real, reemplazar por:
     - cargar AudioBuffer y loopearlo:
         fetch('miArchivo.mp3') -> decodeAudioData -> bufferSource.loop = true ...
     - o usar HTMLAudioElement con loop=true
   Retorna un objeto con método stop()
*/
function playToneFor(row, col) {
  const audioFiles = [
    ['guitarra1.mp3', 'guitarra2.mp3', 'guitarra3.mp3'],
    ['bateria1.mp3', 'bateria2.mp3', 'bateria3.mp3'],
    ['piano1.mp3', 'piano2.mp3', 'piano3.mp3'],
    ['voz1.mp3', 'voz2.mp3', 'voz3.mp3']
  ];

  const file = audioFiles[row][col];
  const audio = new Audio(file);
  audio.loop = true;
  audio.volume = 0.5; // podés ajustar esto

  // iniciar reproducción
  audio.play();

  return {
    stop: () => {
      audio.pause();
      audio.currentTime = 0;
    },
    label: labels[row][col]
  };
}

/* --------- UI updates --------- */
function refreshGridSelectedMarkers(){
  Array.from(padGrid.children).forEach(el=>{
    el.classList.remove('selected');
    const r = Number(el.dataset.row), c = Number(el.dataset.col);
    if(selected[r] && selected[r].col === c){
      el.classList.add('selected');
    }
  });
}

function refreshSelectionsUI(){
  // clear stack area entries (but keep header text)
  // remove all except the first child (intro text)
  while(stackArea.children.length > 1){
    stackArea.removeChild(stackArea.lastChild);
  }
  for(let r=0;r<ROWS;r++){
    if(selected[r]){
      const wrapper = document.createElement('div');
      wrapper.className = 'stack-item';
      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.innerHTML = `<strong>${selected[r].label}</strong><div style="font-size:12px;color:${getComputedStyle(document.documentElement).getPropertyValue('--muted')};">fila ${r+1}</div>`;
      const btn = document.createElement('button');
      btn.className = 'btn';
      btn.textContent = 'Quitar';
      btn.addEventListener('click', ()=>{
        stopSelection(r);
        refreshSelectionsUI();
        refreshGridSelectedMarkers();
      });
      wrapper.appendChild(meta);
      wrapper.appendChild(btn);
      stackArea.appendChild(wrapper);
    }
  }
  refreshGridSelectedMarkers();
}

/* stop and clear selected row */
function stopSelection(row){
  if(!selected[row]) return;
  try{
    selected[row].nodeObj.stop();
  }catch(e){ /* ignore */ }
  selected[row] = null;
}

/* build and initial update */
buildGrid();

/* Accessibility: if user clicks outside, let container keep focus */
document.querySelector('.container').addEventListener('click', ()=> document.querySelector('.container').focus());

/*
  --- NOTAS para usar archivos reales ---
  Si quieres que cada item reproduzca un archivo real:
  1) Tener un array con rutas: audioFiles[row][col] = 'tracks/guit1.mp3'
  2) Reemplazar playToneFor(row,col) por una función que:
     - crea AudioBufferSourceNode o HTMLAudioElement
     - set loop = true
     - con WebAudio: source.connect(gain) -> destination
     - start()
     - returned object debe tener stop() que pause/stop y desconecte
  3) Ten en cuenta autoplay policies: es preferible que la reproducción se inicie
     tras una interacción del usuario (el 'j' sirve para eso).
*/
</script>

</body>
</html>
