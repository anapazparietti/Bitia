<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Panel de composición - demo</title>
<style>
  :root{
    --bg:#f3f3f6;
    --panel:#ececf0;
    --card:#d9d9de;
    --accent:#f9f9fb;
    --highlight:#f9d3ff;
    --muted:#9b9ba6;
  }
  body{ margin:0; font-family:Inter,system-ui,Arial; background-image: url(Diseño/Frame\ 4.png); color:#222; 
  background-size: cover;
  }
  .container{
    max-width: 100%;
    height: 90vh;
    display: flex;
    background:#ffffff00;
    padding:20px;
    align-items: center;
    justify-content: center;
  }

  .container2{
    box-shadow:0 6px 24px rgba(0,0,0,0.08);
    display:flex;
    gap:18px;
    background-image: url(Diseño/Frame\ 3.png);
    background-size: cover;
    padding-top: 60px;
    align-items:center;
    justify-content: center;
    width: 130vh;
    border-radius: 10px;
    height: 60vh;
  }

  .grid-panel{
    background: #56303000;
    padding:16px;
    border-radius:8px;
    overflow:hidden;
    position:relative;
  }
  .pad-grid{
    display:grid;
    grid-template-columns: repeat(3,1fr);
    grid-auto-rows: 95px;
    gap:12px;
    user-select:none;
    height:calc(100% - 28px);
  }
  .pad{
    border-radius:20px;
    background:linear-gradient(180deg,#e6e6eb,#dcdce3);
    display:flex;
    align-items:center;
    justify-content:center;
    position:relative;
    transition:transform .12s ease, box-shadow .12s ease, background .12s;
    cursor:pointer;
    box-shadow: inset 0 -4px 0 rgba(0,0,0,0.03);
    width: 90px;
    height: 90px;
    font-size: 0px;
  }
  .pad:active{ transform:scale(.995); }
  .pad.cursor{
    outline:4px solid rgba(255, 255, 255, 0.511);
    transform: translateY(-3px);
    box-shadow:0 8px 20px rgba(43,124,255,0.12);
  }
  .pad.selected{
    background:linear-gradient(180deg,#ffffff,#eaf3ff);
    border:4px solid var(--highlight);
    transform: scale(1.02);
  }

  .composer-panel{
    background:#815f5f00;
    border-radius:8px;
    box-shadow: inset 0 1px 0 rgba(0,0,0,0.02);
    width: 60%;
    height: 60vh;
  }
  .stack{
    margin-top:8px;
    border-radius:8px;
    padding:12px;
    background:#22222200;
  }
  .stack-item{
    display:flex;
    justify-content:space-between;
    align-items:self-start;
    max-width: 100%;
    padding:10px;
    border-radius:6px;
    background:#ffffffc6;
    box-shadow:0 2px 6px rgba(0,0,0,0.03);
    margin-bottom:8px;
    height: 10vh;
  }
  .stack-item .meta{ font-size:13px; color:#222; }
  .stack-item .btn{ background:#f2f2f6; padding:6px 8px; border-radius:6px; cursor:pointer; font-size:13px; color:#444; border:none; }

  .rightbar{
    background: #00000000;
    padding:14px;
    border-radius:8px;
    width: 25vh;
    height:560px;
    display:flex;
    flex-direction:column;
    gap:10px;
    align-items:center;
    justify-content:center;
  }
  .rightbar img{
    width: 115px;
    border-radius:10px;
    transition:transform .15s, box-shadow .15s;
  }
  .rightbar img.focused{
    outline:4px solid rgba(255,255,255,0.7);
    transform:scale(1.05);
    box-shadow:0 8px 20px rgba(0,0,0,0.25);
  }

  .barra{
    position: absolute;
    background-image: url(Diseño/barra\ de\ abajo.png);
    width: 100%;
    height: 10vh;
    top: 90vh;
  }

  .player{
    width: 130vh;
    background-color: #99b7c3da;
    border-bottom-left-radius: 10px;
    border-bottom-right-radius: 10px;
    height: 10vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .player img{
    width: 30vh;
    margin-left: 3vh;
  }

  .all{
    display: flex;
    flex-direction: column;
    width: 130vh;
    gap: 0 !important;
    padding: 0 !important;
  }

  @media (max-width:980px){
    .container{ grid-template-columns:1fr; padding:10px; }
    .rightbar{ order:3; height:auto; flex-direction:row; justify-content:space-around; }
  }
</style>
</head>
<body>

<div class="container" tabindex="0">
  <div class="all">
    <div class="container2" tabindex="0">
      <div class="grid-panel" id="gridPanel">
        <div class="pad-grid" id="padGrid" aria-label="Grid de instrumentos"></div>
      </div>
      <div class="composer-panel" aria-live="polite">
        <div class="stack" id="stackArea">
          <div style="color:var(--muted); font-size:0px;">Pistas seleccionadas (apiladas):</div>
        </div>
      </div>
    </div>

    <div class="player">
      <div class="wire-btn circle" title="play/stop"></div>
      <img src="Diseño/barra reproductor.png" alt="">
    </div>
  </div>

  <aside class="rightbar" id="rightBar">
    <div><a href="#"><img src="" alt=""></a></div>
    <div><a href="index.html"><img src="Diseño/Frame 4 (1).png" alt=""></a></div>
    <div><a href="#"><img src="Diseño/Frame 5.png" alt=""></a></div>
    <div><a href="index.html"><img src="Diseño/Frame 6.png" alt=""></a></div>
  </aside>
</div>

<div class="barra"></div>

<script>
const padGrid = document.getElementById('padGrid');
const stackArea = document.getElementById('stackArea');
const rightBar = document.getElementById('rightBar');
let rightBarImgs = rightBar.querySelectorAll('img'); // Cambiado a 'let' para reasignación

const ROWS = 4, COLS = 3;
let currentRow = 0, currentCol = 0;
let mode = 'grid'; // "grid" o "rightbar"
let rightBarIndex = 0;

const labels = [
    ['Guitarra 1','Guitarra 2','Guitarra 3'],
    ['Bateria 1','Bateria 2','Bateria 3'],
    ['Piano 1','Piano 2','Piano 3'],
    ['Voz 1','Voz 2','Voz 3']
];

let audioCtx = null;
function ensureAudio(){ if(!audioCtx){ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); } }

const selected=[null,null,null,null];
const padImages=[
    ['Diseño/Property 1=Frame 1.png','Diseño/Property 1=Frame 2.png','Diseño/Property 1=Frame 13.png'],
    ['Diseño/Component 24.png','Diseño/Component 25.png','Diseño/Component 26.png'],
    ['Diseño/Component 27.png','Diseño/Component 28.png','Diseño/Component 29.png'],
    ['Diseño/Component 30.png','Diseño/Component 31.png','Diseño/Component 32.png']
];

// ----------------------------------------------------------------------
// NUEVAS FUNCIONES PARA EL BOTÓN "TERMINAR"
// ----------------------------------------------------------------------

// 1. Verifica si todas las 4 pistas tienen un instrumento seleccionado
function checkCompletion() {
    // Retorna true si todos los elementos de 'selected' son no nulos
    return selected.every(selection => selection !== null);
}

// 2. Actualiza la visibilidad del botón "Terminar"
// 2. Actualiza la visibilidad del botón "Terminar"
function updateFinishButton() {
    const isCompleted = checkCompletion();
    let finishBtn = document.getElementById('finish-img');
    let finishLink = document.getElementById('finish-link');
    let finishWrapper = document.getElementById('finish-btn-wrapper');

    // Crea el elemento si no existe
    if (!finishBtn) {
        finishWrapper = document.createElement('div');
        finishWrapper.id = 'finish-btn-wrapper';
        finishWrapper.style.display = 'none';
        
        finishLink = document.createElement('a');
        finishLink.href = 'fin.html';
        finishLink.id = 'finish-link';
        finishLink.title = 'Terminar Composición';
        
        // El contenedor DIV en el rightbar necesita un ancho o flex-basis
        // para asegurar que toma espacio, aunque tu CSS ya maneja el tamaño de la imagen.
        
        finishBtn = document.createElement('img');
        
        // ⭐⭐ ASEGÚRATE QUE ESTA RUTA ES CORRECTA ⭐⭐
        finishBtn.src = 'Diseño/Frame_21(2).png'; 
        finishBtn.alt = 'Terminar';
        finishBtn.id = 'finish-img';
        
        // Añadir evento de clic para el botón creado dinámicamente (para mouse)
        finishLink.addEventListener('click', (e) => {
            e.preventDefault();
            window.location.href = finishLink.getAttribute('href');
        });

        finishLink.appendChild(finishBtn);
        finishWrapper.appendChild(finishLink);
        rightBar.appendChild(finishWrapper);
    }
    
    // Muestra u oculta el botón
    if (isCompleted) {
        finishWrapper.style.display = 'block'; 
        // Nota: El 'div' se muestra, y la imagen dentro toma el estilo '.rightbar img'.
    } else {
        finishWrapper.style.display = 'none';
    }
    
    // Vuelve a obtener la lista de imágenes, incluyendo la nueva si existe
    rightBarImgs = rightBar.querySelectorAll('img');

    // Si el índice enfocado actual es el botón "Terminar" y este se oculta, reinicia el foco.
    if (!isCompleted && rightBarIndex >= rightBarImgs.length) {
        rightBarIndex = 0;
        updateRightbarFocus();
    }
}

// ----------------------------------------------------------------------
// FUNCIONES EXISTENTES MODIFICADAS (Añadiendo updateFinishButton)
// ----------------------------------------------------------------------

function buildGrid(){
    padGrid.innerHTML='';
    for(let r=0;r<ROWS;r++){
        for(let c=0;c<COLS;c++){
            const el=document.createElement('div');
            el.className='pad';
            el.style.backgroundImage=`url('${padImages[r][c]}')`;
            el.style.backgroundSize='cover';
            el.style.backgroundPosition='center';
            el.dataset.row=r; el.dataset.col=c;
            el.innerHTML=`<div class="label">${labels[r][c]}</div>`;
            el.addEventListener('click',()=>{ currentRow=r; currentCol=c; updateCursor(); selectCurrent(); });
            padGrid.appendChild(el);
        }
    }
    updateCursor(); refreshSelectionsUI();
    updateFinishButton(); // <--- AÑADIDO
}

function getPadElement(row,col){ return padGrid.children[row*COLS+col]; }

function updateCursor(){
    Array.from(padGrid.children).forEach(el=>el.classList.remove('cursor'));
    if(mode==='grid'){
        const el=getPadElement(currentRow,currentCol);
        if(el) el.classList.add('cursor');
    }
}

function clampMod(v,mod){ return ((v%mod)+mod)%mod; }

// --- Scroll para grid y rightbar ---
window.addEventListener('wheel', e => {
    if (mode === 'grid') {
        e.preventDefault();
        currentCol = clampMod(currentCol + (e.deltaY > 0 ? 1 : -1), COLS);
        updateCursor();
    } else if (mode === 'rightbar') {
        e.preventDefault();
        rightBarIndex = clampMod(rightBarIndex + (e.deltaY > 0 ? 1 : -1), rightBarImgs.length);
        updateRightbarFocus();
    }
}, { passive: false });


function updateRightbarFocus(){
    rightBarImgs.forEach((img,i)=>{
        img.classList.toggle('focused', i===rightBarIndex);
    });
}

let jTimeout = null;
let jLongPress = false;
const jHoldThreshold = 2000; // 2 segundos

window.addEventListener('keydown', e => {
    const key = e.key.toLowerCase();

    // --- Play/Pause con la tecla '1' (Añadido en el paso anterior) ---
    if (key === '1' && !e.repeat) {
        document.querySelector('.wire-btn.circle').click();
        e.preventDefault();
    }

    // --- J largo: alternar grid / rightbar ---
    if (key === 'z' && !jTimeout) {
        jLongPress = false;
        jTimeout = setTimeout(() => {
            jLongPress = true;

            // Alternar modo
            mode = (mode === 'grid') ? 'rightbar' : 'grid';
            updateCursor();
            updateRightbarFocus();

            jTimeout = null;
        }, jHoldThreshold);
    }

    // --- Alternar modo con X ---
    if (key === 'x') {
        mode = (mode === 'grid') ? 'rightbar' : 'grid';
        updateCursor();
        updateRightbarFocus();
    }

    // --- Navegación ---
    if (mode === 'grid') {
        if (key === '}') { currentRow = clampMod(currentRow + 1, ROWS); updateCursor(); }
        else if (key === 'k') { currentRow = clampMod(currentRow - 1, ROWS); updateCursor(); }
    } else if (mode === 'rightbar') {
        // La longitud de rightBarImgs.length se actualiza en updateFinishButton
        if (key === '}') { rightBarIndex = clampMod(rightBarIndex + 1, rightBarImgs.length); updateRightbarFocus(); }
        else if (key === 'k') { rightBarIndex = clampMod(rightBarIndex - 1, rightBarImgs.length); updateRightbarFocus(); }
    }
});

window.addEventListener('keyup', e => {
    const key = e.key.toLowerCase();

    if (key === 'z') {
        if (jTimeout) {
            clearTimeout(jTimeout);
            jTimeout = null;
        }

        // --- Acción corta solo si no fue J largo ---
        if (!jLongPress) {
            if (mode === 'grid') selectCurrent();
            else if (mode === 'rightbar') {
                const target = rightBarImgs[rightBarIndex];
                if (!target) return;
                const parentLink = target.closest('a');
                
                // Si tiene un 'href' (incluido el nuevo botón Terminar con 'fin.html'), navega.
                if (parentLink && parentLink.getAttribute('href') && parentLink.getAttribute('href') !== '#') {
                    window.location.href = parentLink.getAttribute('href');
                } else {
                    activateRightbarItem();
                }
            }
        }
    }
});


function activateRightbarItem(){
    const target=rightBarImgs[rightBarIndex];
    if(!target) return;
    // Acción de ejemplo (si no es un enlace de navegación)
    console.log('Seleccionaste:', target.src);
    target.style.transform='scale(1.2)';
    setTimeout(()=>updateRightbarFocus(),200);
}

async function selectCurrent(){
    ensureAudio();
    if(audioCtx.state==='suspended') await audioCtx.resume();
    const row=currentRow, col=currentCol;
    if(selected[row] && selected[row].col===col){ stopSelection(row); refreshSelectionsUI(); refreshGridSelectedMarkers(); return; }
    if(selected[row]) stopSelection(row);
    const label=labels[row][col];
    const nodeObj=await playToneFor(row,col);
    selected[row]={col,label,nodeObj};
    refreshSelectionsUI(); refreshGridSelectedMarkers();
    updateFinishButton(); // <--- AÑADIDO
}

async function playToneFor(row,col){
    const audioFiles=[
        ['Musicas/guitarra1.mp3','Musicas/guitarra2.mp3','Musicas/guitarra3.mp3'],
        ['Musicas/bateria1.mp3','Musicas/bateria2.mp3','Musicas/bateria3.mp3'],
        ['Musicas/piano1.mp3','Musicas/piano2.mp3','Musicas/piano3.mp3'],
        ['voz1.mp3','voz2.mp3','voz3.mp3']
    ];
    const file=audioFiles[row][col];
    const audio=new Audio(file);
    audio.loop=false; audio.volume=0.6;
    for(let r=0;r<ROWS;r++){
        if(selected[r]?.nodeObj?.audio){ selected[r].nodeObj.audio.pause(); selected[r].nodeObj.audio.currentTime=0; }
    }
    audio.play().catch(()=>{});
    audio.addEventListener('ended',()=>{audio.currentTime=0;});
    ensureAudio();
    let audioBuffer=null;
    try{
        const resp=await fetch(file);
        const ab=await resp.arrayBuffer();
        audioBuffer=await audioCtx.decodeAudioData(ab.slice(0));
    }catch(err){ console.warn('No se pudo decodificar:',err); }
    return{audio,audioBuffer,stop:()=>{audio.pause();audio.currentTime=0;},label:labels[row][col]};
}

// ------- Play/Pause global -------
let isPlaying=false;
const playButton=document.querySelector('.wire-btn.circle');
playButton.textContent='▶️';
playButton.addEventListener('click',()=>{
    ensureAudio();
    if(audioCtx.state==='suspended') audioCtx.resume();
    for(let r=0;r<ROWS;r++){ if(selected[r]?.nodeObj?.audio){ selected[r].nodeObj.audio.pause(); selected[r].nodeObj.audio.currentTime=0; } }
    if(!isPlaying){
        for(let r=0;r<ROWS;r++){ if(selected[r]?.nodeObj?.audio){ const a=selected[r].nodeObj.audio; a.currentTime=0; a.play().catch(()=>{}); } }
        playButton.textContent='⏸️';
    }else{
        for(let r=0;r<ROWS;r++){ if(selected[r]?.nodeObj?.audio){ selected[r].nodeObj.audio.pause(); } }
        playButton.textContent='▶️';
    }
    isPlaying=!isPlaying;
});

function drawWaveform(audioBuffer,canvas){
    const ctx=canvas.getContext('2d');
    const width=canvas.width, height=canvas.height;
    ctx.clearRect(0,0,width,height);
    if(!audioBuffer){ ctx.fillText('⚠️ Sin forma de onda',10,20); return; }
    const data=audioBuffer.getChannelData(0);
    const step=Math.ceil(data.length/width);
    const amp=height/2;
    ctx.beginPath();
    for(let i=0;i<width;i++){
        let min=1,max=-1;
        for(let j=0;j<step;j++){ const datum=data[i*step+j]; if(datum<min)min=datum; if(datum>max)max=datum; }
        ctx.lineTo(i,(1+min)*amp); ctx.lineTo(i,(1+max)*amp);
    }
    ctx.strokeStyle='#2e6bf0'; ctx.lineWidth=1; ctx.stroke();
}

function refreshGridSelectedMarkers(){
    Array.from(padGrid.children).forEach(el=>{
        el.classList.remove('selected');
        const r=+el.dataset.row,c=+el.dataset.col;
        if(selected[r] && selected[r].col===c) el.classList.add('selected');
    });
}

function refreshSelectionsUI(){
    while(stackArea.children.length>1) stackArea.removeChild(stackArea.lastChild);
    for(let r=0;r<ROWS;r++){
        if(selected[r]){
            const wrapper=document.createElement('div');
            wrapper.className='stack-item';
            wrapper.style.display='flex';
            wrapper.style.flexDirection='column';
            wrapper.style.gap='6px';

            const top=document.createElement('div');
            top.style.display='flex';
            top.style.justifyContent='space-between';
            top.style.alignItems='center';

            const meta=document.createElement('div');
            meta.className='meta';
            meta.innerHTML=`<strong>${selected[r].label}</strong>`;

            const btn=document.createElement('button');
            btn.className='btn';
            btn.textContent='Quitar';
            btn.addEventListener('click',()=>{ stopSelection(r); refreshSelectionsUI(); refreshGridSelectedMarkers(); });

            top.appendChild(meta); top.appendChild(btn); wrapper.appendChild(top);
            const canvas=document.createElement('canvas'); canvas.width=300; canvas.height=60; wrapper.appendChild(canvas);
            if(selected[r].nodeObj?.audioBuffer){ drawWaveform(selected[r].nodeObj.audioBuffer,canvas); }
            stackArea.appendChild(wrapper);
        }
    }
    refreshGridSelectedMarkers();
    // updateFinishButton(); // No es necesario aquí si selectCurrent y stopSelection lo llaman.
}

function stopSelection(row){ 
    if(!selected[row])return; 
    try{selected[row].nodeObj.stop();}catch(e){} 
    selected[row]=null; 
    updateFinishButton(); // <--- AÑADIDO
}

buildGrid();
document.querySelector('.container').addEventListener('click',()=>document.querySelector('.container').focus());
updateRightbarFocus();
</script>
</body>
</html>

